---
import { getBlogPosts } from "../../lib/directus";
import { getCurrentLanguage } from "../../lib/i18n";
import { t } from "../../lib/translations";

const currentLang = getCurrentLanguage(Astro.url);
const heading = await t("latest.heading", currentLang, "Latest From Us");
const minRead = await t("latest.min_read", currentLang, "min read");

const articles = await getBlogPosts({
  limit: 3,
  filter: { status: { _eq: "published" } },
  sort: ["-published_date"],
  fields: ["id", "title", "slug", "published_date", "content"],
});

function calculateReadingTime(text: string): number {
  if (!text) return 0;
  const wordsPerMinute = 200;
  const words = text.trim().split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}
---

<section
  class="latest-from-us py-16 lg:py-24 bg-[var(--color-background)] text-[var(--color-foreground)]"
>
  <div class="max-w-[1440px] mx-auto px-6 sm:px-8 lg:px-12 xl:px-16">
    {/* Header */}
    <div class="flex items-center gap-6 mb-12">
      <h2 class="uppercase text-xs font-semibold tracking-wider">
        {heading}
      </h2>
      <div class="flex-1 h-px bg-[var(--color-border)]" aria-hidden="true">
      </div>
    </div>

    {/* Grid */}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 lg:gap-12">
      {
        articles.map((post) => (
          <article class="group flex flex-col justify-between h-full last:border-0 pb-8 md:pb-0 pr-0 md:pr-8 lg:pr-12">
            <div class="space-y-6">
              <h3 class="text-2xl font-medium leading-tight">
                <a
                  href={`/${currentLang}/blog/${post.slug}`}
                  class="hover:underline decoration-1 underline-offset-4"
                >
                  {post.title}
                </a>
              </h3>
            </div>

            <div class="mt-3 pt-3 border-t border-[var(--color-border)]/40 flex items-center justify-between text-xs uppercase tracking-wider opacity-70">
              <time datetime={post.published_date}>
                {new Date(post.published_date).toLocaleDateString(
                  currentLang === "de" ? "de-DE" : "en-GB",
                  {
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                  }
                )}
              </time>
              <span>
                {calculateReadingTime(post.content || "")} {minRead}
              </span>
            </div>
          </article>
        ))
      }
    </div>
  </div>
</section>
