---
import { getTeamMembers, getAssetUrl } from '../../lib/directus';
import { getCurrentLanguage, getLocalizedField } from '../../lib/i18n';
import { t } from '../../lib/translations';

// Get current language
const currentLang = getCurrentLanguage(Astro.url);
const heading = await t('team.heading', currentLang, 'TEAM');

// Fetch team members from Directus
const teamMembersData = await getTeamMembers({ featuredOnly: true });

const teamMembers = teamMembersData.length > 0
  ? teamMembersData.map(member => ({
      id: member.id,
      fullName: member.full_name,
      role: getLocalizedField(member, 'role', currentLang) || member.role_en,
      bio: getLocalizedField(member, 'bio', currentLang),
      photo: member.photo ? getAssetUrl(member.photo) : null,
      email: member.email,
      linkedinUrl: member.linkedin_url,
      twitterUrl: member.twitter_url,
      githubUrl: member.github_url,
      slug: member.slug
    }))
  : [];
---

<section class="py-16 md:py-24 relative" aria-labelledby="team-heading">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="mb-12 flex items-center gap-6">
      <h2 id="team-heading" class="text-[12px] sm:text-xs font-mono uppercase text-foreground/70 whitespace-nowrap">
        {heading}
      </h2>
      <div class="h-px flex-1 bg-[var(--color-border)]"></div>
    </div>

    <!-- Team Cards Container -->
    <div class="relative flex justify-center items-center min-h-auto md:min-h-[600px]">
      <div id="team-cards-stack" class="relative w-full flex overflow-x-auto snap-x snap-mandatory gap-0 pb-8 md:block md:pb-0 md:h-[600px] md:overflow-visible scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0">
        {teamMembers.map((member, index) => (
          <div 
            class="team-card flex-shrink-0 w-[200px] snap-center md:w-auto md:flex-shrink-1 md:snap-none -mr-4 last:mr-4 md:mr-0 md:last:mr-0"
            data-member-id={member.id}
            data-index={index}
            data-initial-left=""
            style={`--card-index: ${index};`}
          >
            <!-- Front Side -->
            <div class="card-side card-front">
              <div class="card-image">
                {member.photo ? (
                  <img
                    src={member.photo}
                    alt={member.fullName}
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center bg-muted">
                    <span class="text-6xl font-display text-muted-foreground/30">
                      {member.fullName.split(' ').map(n => n[0]).join('')}
                    </span>
                  </div>
                )}
              </div>
              <div class="card-info">
                <p class="role text-xs font-mono font-medium uppercase text-muted-foreground">
                  {member.role}
                </p>
                <h3 class="name text-2xl md:text-3xl font-display">
                  {member.fullName}
                </h3>
              </div>
            </div>

            <!-- Back Side -->
            <div class="card-side card-back">
              <div class="p-6 md:p-8 h-full flex flex-col justify-between">
                <div>
                  <h3 class="text-2xl md:text-3xl font-display mb-2">
                    {member.fullName}
                  </h3>
                  <p class="text-sm font-mono uppercase tracking-wider mb-6 text-muted-foreground">
                    {member.role}
                  </p>
                  {member.bio && (
                    <p class="text-base leading-relaxed">
                      {member.bio}
                    </p>
                  )}
                </div>
                {(member.linkedinUrl || member.githubUrl || member.email) && (
                  <div class="flex gap-4 mt-6">
                    {member.linkedinUrl && (
                      <a
                        href={member.linkedinUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-muted-foreground hover:text-foreground transition-colors"
                        aria-label={`${member.fullName} on LinkedIn`}
                      >
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                      </a>
                    )}
                    {member.githubUrl && (
                      <a
                        href={member.githubUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-muted-foreground hover:text-foreground transition-colors"
                        aria-label={`${member.fullName} on GitHub`}
                      >
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                      </a>
                    )}
                    {member.email && (
                      <a
                        href={`mailto:${member.email}`}
                        class="text-muted-foreground hover:text-foreground transition-colors"
                        aria-label={`Email ${member.fullName}`}
                      >
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                      </a>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>

  </div>

  <!-- Backdrop blur overlay -->
  <div id="team-backdrop" class="team-backdrop"></div>
</section>

<style>
  .team-card {
    position: relative;
    /* width: 100%; */
    /* max-width: 340px; Removed to allow flex sizing on mobile */
    height: 485px;
    /* margin: 0 auto; Handled by flex gap */
    cursor: pointer;
    /* Slow down flip a bit; keep position transitions snappy */
    transition:
      transform 0.9s cubic-bezier(0.25, 0.8, 0.25, 1),
      left 0.35s ease,
      top 0.35s ease;
    transform-style: preserve-3d;
    perspective: 1000px;
  }

  .team-card.active {
    position: fixed !important;
    left: 50% !important;
    top: 50% !important;
    transform: translate(-50%, -50%) scale(1.1) !important; /* Reduced scale for mobile safety */
    z-index: 1000 !important;
    cursor: pointer;
    width: 90vw !important;
    max-width: 340px !important;
    height: 550px !important; /* Taller for info */
    margin: 0 !important;
  }

  .team-card.flipped {
    transform: translate(-50%, -50%) scale(1.1) rotateY(180deg) !important;
  }

  @media (min-width: 769px) {
    .team-card {
      position: absolute;
      top: 50%;
      left: 50%; /* Start centered or calculated */
      transform: translateY(-50%);
      width: 300px;
      max-width: none;
      height: 485px;
      margin: 0;
    }

    .team-card.active {
      transform: translate(-50%, -50%) scale(1.5) !important;
      width: 300px !important;
      height: 485px !important;
    }

    .team-card.flipped {
      transform: translate(-50%, -50%) scale(1.5) rotateY(180deg) !important;
    }
  }

  .card-side {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
    overflow: hidden;
    background: var(--color-card);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
  }

  .card-back {
    transform: rotateY(180deg);
  }

  .card-image {
    width: 100%;
    flex: 1;
    overflow: hidden;
    background: var(--color-muted);
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    /* Keep image orientation stable while parent flips */
    transition:
      filter 0.3s ease,
      transform 0.9s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  /* Counter-rotate the front image so it does not appear mirrored while flipping */
  .team-card.active .card-front .card-image img,
  .team-card.flipped .card-front .card-image img {
    transform: rotateY(-180deg);
  }

  /* Dim non-hovered cards to emphasize the hovered one */
  #team-cards-stack:hover .team-card:not(:hover):not(.active) {
    filter: brightness(0.8);
  }
  
  /* When a card is active (centered), dim all others slightly */
  #team-cards-stack.stack-has-active .team-card:not(.active) {
    filter: brightness(0.9);
  }

  .card-info {
    padding: 1.5rem;
    border-top: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex-shrink: 0;
  }


  .team-backdrop {
    position: fixed;
    inset: 0;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 999;
  }

  .team-backdrop.active {
    opacity: 1;
    pointer-events: auto;
  }

  /* Hide scrollbar for Chrome, Safari and Opera */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Hide scrollbar for IE, Edge and Firefox */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
</style>

<script>
  class TeamCardStack {
    cards: HTMLElement[];
    activeCard: HTMLElement | null = null;
    backdrop: HTMLElement | null = null;
    container: HTMLElement | null = null;
    isFlipped = false;
    cardPositions: Map<HTMLElement, {left: string, transform: string}> = new Map();

    // Handlers storage for cleanup
    handleKeydown: (e: KeyboardEvent) => void;
    handleResize: () => void;

    constructor() {
      this.cards = Array.from(document.querySelectorAll('.team-card')) as HTMLElement[];
      this.backdrop = document.getElementById('team-backdrop');
      this.container = document.getElementById('team-cards-stack');
      
      this.handleKeydown = (e) => {
        if (e.key === 'Escape' && this.activeCard) {
          this.closeActiveCard();
        }
      };
      
      this.handleResize = () => {
        if (!this.activeCard) {
          this.positionCards();
        }
      };

      this.init();
    }

    init() {
      // Calculate and set initial positions to spread cards across the row
      this.positionCards();

      this.cards.forEach((card, index) => {
        card.addEventListener('click', (e) => this.handleCardClick(e, card));
        card.addEventListener('mouseenter', () => this.handleCardHover(index));
        card.addEventListener('mouseleave', () => this.handleCardUnhover());
      });

      this.backdrop?.addEventListener('click', () => this.closeActiveCard());

      document.addEventListener('keydown', this.handleKeydown);
      window.addEventListener('resize', this.handleResize);
    }
    
    destroy() {
      document.removeEventListener('keydown', this.handleKeydown);
      window.removeEventListener('resize', this.handleResize);
    }

    positionCards() {
      const container = document.getElementById('team-cards-stack');
      if (!container) return;

      const containerWidth = container.offsetWidth;
      const cardCount = this.cards.length;
      
      // Responsive card width - match CSS
      const isMobile = window.innerWidth <= 768;
      const cardWidth = 300;
      
      if (isMobile) {
        // Mobile: Grid layout managed by CSS - Clear all inline styles
        this.cards.forEach((card) => {
          card.style.position = '';
          card.style.left = '';
          card.style.top = '';
          card.style.transform = '';
        });
        return;
      }

      // Desktop: Spread cards horizontally with comfortable spacing
      const spacing = cardWidth * 0.7; // More spread out by default
      const totalCardsWidth = (cardCount - 1) * spacing + cardWidth;
      const overflow = totalCardsWidth - containerWidth;
      const startOffset = -(overflow / 2);

      this.cards.forEach((card, index) => {
        const leftPosition = startOffset + (index * spacing) + (cardWidth / 2);
        const leftValue = `${leftPosition}px`;
        const transformValue = 'translateY(-50%) translateX(-50%)';
        
        // Store initial position
        this.cardPositions.set(card, {
          left: leftValue,
          transform: transformValue
        });

        // Apply position
        card.style.position = 'absolute';
        card.style.left = leftValue;
        card.style.top = '50%';
        card.style.transform = transformValue;
      });
    }

    handleCardClick(e: Event, card: HTMLElement) {
      e.stopPropagation();

      if (this.activeCard === card) {
        // Card is already active - close it
        this.closeActiveCard();
      } else if (this.activeCard) {
        // Another card is active - close it first
        this.closeActiveCard();
        setTimeout(() => this.openCard(card), 300);
      } else {
        // No card is active - open this one
        this.openCard(card);
      }
    }

    handleCardHover(hoveredIndex: number) {
      if (this.activeCard) return; // Don't push if a card is already active

      const isMobile = window.innerWidth <= 768;
      if (isMobile) return; // Skip on mobile

      // Local ripple push: only nearby cards move, with falloff
      // Keeps stack within bounds and visually tight
      const basePush = 70; // px space around hovered card
      const falloff = [1.0, 0.5, 0.25, 0.125]; // distance 1..4

      this.cards.forEach((card, index) => {
        const initialPos = this.cardPositions.get(card);
        if (!initialPos) return;

        if (index === hoveredIndex) {
          card.style.left = initialPos.left;
          return;
        }

        const distance = Math.abs(index - hoveredIndex);
        if (distance > falloff.length) {
          // Far cards don't move
          card.style.left = initialPos.left;
          return;
        }

        const direction = index < hoveredIndex ? -1 : 1;
        const shift = direction * basePush * falloff[distance - 1];

        const initialLeft = parseFloat(initialPos.left);
        card.style.left = `${initialLeft + shift}px`;
      });
    }
    
    handleCardUnhover() {
      if (this.activeCard) return;
      
      const isMobile = window.innerWidth <= 768;
      if (isMobile) return;

      // Restore all cards to their initial positions
      this.cards.forEach((card) => {
        const initialPos = this.cardPositions.get(card);
        if (initialPos) {
          card.style.left = initialPos.left;
        }
      });
    }

    openCard(card: HTMLElement) {
      this.activeCard = card;
      this.isFlipped = true;
      
      // Add both active and flipped classes immediately
      // The card will flip while moving to center
      card.classList.add('active', 'flipped');
      this.backdrop?.classList.add('active');
      this.container?.classList.add('stack-has-active');
    }

    closeActiveCard() {
      if (!this.activeCard) return;

      const card = this.activeCard;
      
      // Remove active and flipped classes - CSS will animate back
      card.classList.remove('active', 'flipped');
      this.backdrop?.classList.remove('active');
      this.container?.classList.remove('stack-has-active');
      
      // Reset position to absolute after animation completes
      setTimeout(() => {
        if (card && !card.classList.contains('active')) {
          const isMobile = window.innerWidth <= 768;
          
          if (isMobile) {
            // Clear styles for mobile grid layout
            card.style.position = '';
            card.style.left = '';
            card.style.top = '';
            card.style.transform = '';
          } else {
            // Restore desktop position
            const initialPos = this.cardPositions.get(card);
            if (initialPos) {
              card.style.position = 'absolute';
              card.style.left = initialPos.left;
              card.style.transform = initialPos.transform;
              card.style.top = '50%';
            }
          }
        }
      }, 600); // Match the CSS transition duration
      
      this.activeCard = null;
      this.isFlipped = false;
    }
  }

  let currentStack: TeamCardStack | null = null;

  function initTeamCards() {
    if (currentStack) {
      currentStack.destroy();
    }
    currentStack = new TeamCardStack();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTeamCards);
  } else {
    initTeamCards();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initTeamCards);
  document.addEventListener('astro:before-swap', () => {
    if (currentStack) {
      currentStack.destroy();
      currentStack = null;
    }
  });
</script>
