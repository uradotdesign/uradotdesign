---
import { getServices, getAssetUrl } from "../../lib/directus";
import { getCurrentLanguage, getLocalizedField } from "../../lib/i18n";
import { t } from "../../lib/translations";

export interface Props {
  currentService: {
    id: number; // Changed to number to match Service.id
    slug: string;
    title: string;
    subtitle?: string;
    description: string;
    extendedDescription?: string;
    colorAccent: string;
    backgroundLight?: string | null;
    backgroundDark?: string | null;
    sectionHeading?: string;
    sectionSubheading?: string;
    checklistItems?: Array<{ text: string }>;
    [key: string]: any; // Allow additional properties
  };
}

const { currentService } = Astro.props;
const currentLang = getCurrentLanguage(Astro.url);
const letsTalk = await t('services.lets_talk', currentLang, "LET'S TALK");

// Fetch all services for tabs
const allServicesData = await getServices({
  fields: [
    "id",
    "slug",
    "title_en",
    "title_de",
    "service_icon",
    "color_accent",
    "status",
    "show_in_hero"
  ]
});

// Helper function to fetch SVG content
async function fetchSvgContent(url: string): Promise<string | null> {
  try {
    const response = await fetch(url);
    if (!response.ok) return null;
    const text = await response.text();
    return text;
  } catch (error) {
    console.error('Error fetching SVG:', error);
    return null;
  }
}

const allServices = await Promise.all(
  allServicesData
    .filter((s) => s && s.slug && s.status === "published" && s.show_in_hero !== false)
    .map(async (s) => {
      let svgContent: string | null = null;
      if (s.service_icon) {
        const iconUrl = getAssetUrl(s.service_icon);
        if (iconUrl) {
          svgContent = await fetchSvgContent(iconUrl);
        }
      }
      
      return {
        id: s.id,
        slug: s.slug,
        title:
          getLocalizedField(s, "title", currentLang) ??
          s.title_en ??
          s.title_de ??
          s.slug,
        colorAccent: s.color_accent || "#10b981",
        serviceIcon: s.service_icon,
        svgContent,
      };
    })
);
---

<section
  class="relative pt-20 lg:pt-32 pb-32 lg:pb-40 px-6 sm:px-8 lg:px-12 xl:px-16 overflow-hidden h-auto md:h-auto md:min-h-screen"
  style={`--hero-accent: ${currentService.colorAccent || "#10b981"};`}
>
  <!-- Background Image with Gradient Bleed -->
  <div class="absolute inset-0 z-0" id="hero-background">
    {currentService.backgroundLight && (
      <div class="hero-bg-light absolute inset-0">
        <div
          class="absolute inset-0 bg-center bg-cover"
          style={`background-image: url('${currentService.backgroundLight}');`}
          aria-hidden="true"
        />
        <!-- Gradient bleed for light theme -->
        <div
          class="absolute inset-0"
          style="background: linear-gradient(to bottom, transparent 0%, transparent 1%, #fafafa 100%);"
          aria-hidden="true"
        />
      </div>
    )}
    {currentService.backgroundDark && (
      <div class="hero-bg-dark absolute inset-0 hidden">
        <div
          class="absolute inset-0 bg-center bg-cover"
          style={`background-image: url('${currentService.backgroundDark}');`}
          aria-hidden="true"
        />
        <!-- Gradient bleed for dark theme -->
        <div
          class="absolute inset-0"
          style="background: linear-gradient(to bottom, transparent 0%, transparent 1%, #0c111d 100%);"
          aria-hidden="true"
        />
      </div>
    )}
  </div>

  <div class="relative z-10 max-w-7xl mx-auto h-full flex flex-col md:block justify-between">
    <!-- Service Navigation Tabs (Right-aligned) -->
    <div class="mt-12 lg:mt-24 mb-4 flex justify-start md:justify-end shrink-0 overflow-x-auto overflow-y-hidden scrollbar-hide">
      <nav
        class="flex items-center relative border-b border-foreground/10 w-auto"
        aria-label="Service navigation"
      >
        {
          allServices.map((service, index) => {
            const isActive = service.slug === currentService.slug;

            // Use fetched SVG content or fallback to hardcoded icons
            let Icon = "";
            if (service.svgContent) {
              // Check if the SVG uses fill or stroke
              const usesFill = service.svgContent.includes('fill=') && !service.svgContent.includes('fill="none"');
              
              // Remove any existing stroke/fill attributes and replace with our own
              Icon = service.svgContent
                .replace(/stroke="[^"]*"/g, '')
                .replace(/fill="[^"]*"/g, '')
                .replace(/<svg/, usesFill 
                  ? `<svg class="w-4 h-4 md:w-6 md:h-6" fill="currentColor"`
                  : `<svg class="w-4 h-4 md:w-6 md:h-6" stroke="currentColor" fill="none" stroke-width="${isActive ? "2.5" : "1.5"}"`
                );
            } else {
              // Fallback to hardcoded SVG icons based on slug
              if (
                service.slug.includes("audit") ||
                service.slug.includes("forensic")
              ) {
                // Eye Icon
                Icon = `<svg class="w-4 h-4 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="${isActive ? "2.5" : "1.5"}"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
              } else if (
                service.slug.includes("system") ||
                service.slug.includes("blueprint")
              ) {
                // Slash/Lines Icon
                Icon = `<svg class="w-4 h-4 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="${isActive ? "2.5" : "1.5"}"><path stroke-linecap="round" stroke-linejoin="round" d="M19 5L5 19M5 5l14 14" /></svg>`;
                if (service.slug.includes("blueprint")) {
                  Icon = `<svg class="w-4 h-4 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="${isActive ? "2.5" : "1.5"}"><path stroke-linecap="round" stroke-linejoin="round" d="M10 5L4 21M20 5L14 21" /></svg>`;
                }
              } else {
                // Star/Sparkle Icon (Brand Alignment)
                Icon = `<svg class="w-4 h-4 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="${isActive ? "2.5" : "1.5"}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2v20m10-10H2m17.07 7.07L4.93 4.93m14.14 0L4.93 19.07" /></svg>`;
              }
            }

            return (
              <a
                href={`/${currentLang}/${service.slug}`}
                class:list={[
                  "service-tab group flex items-center gap-0 md:gap-4 py-3 md:py-4 transition-all duration-300 relative shrink-0",
                  index === 0 ? "pl-0 pr-3 md:pr-6" : index === allServices.length - 1 ? "pl-3 md:pl-6 pr-0" : "px-3 md:px-6",
                  isActive
                    ? "text-foreground font-medium opacity-100"
                    : "text-foreground font-normal opacity-40 hover:opacity-70",
                ]}
                data-active={isActive}
                data-color={service.colorAccent}
                style={`--tab-accent: ${service.colorAccent || currentService.colorAccent || "#10b981"}`}
              >
                {/* Icon */}
                <div
                  class:list={[
                    "relative flex items-center justify-center w-6 h-6 md:w-8 md:h-8 transition-all duration-300",
                    isActive
                      ? "text-[var(--tab-accent)] md:text-white bg-transparent md:bg-[var(--tab-accent)]"
                      : "text-foreground",
                  ]}
                >
                  {/* Background box for active state */}
                  {isActive && (
                    <div
                      class="absolute inset-0 -z-10 hidden md:block"
                      style={`background-color: ${service.colorAccent};`}
                      aria-hidden="true"
                    />
                  )}
                  <Fragment set:html={Icon} />
                </div>

                <span class="text-sm md:text-lg whitespace-nowrap">{service.title}</span>

                {/* Active tab thicker colored border */}
                {isActive && (
                  <span
                    class:list={[
                      "absolute bottom-0 h-[4px] translate-y-1/2 z-10 bg-[var(--tab-accent)]",
                      index === 0 ? "left-0 right-3 md:right-6" : index === allServices.length - 1 ? "left-3 md:left-6 right-0" : "left-3 md:left-6 right-3 md:right-6"
                    ]}
                    aria-hidden="true"
                  />
                )}
              </a>
            );
          })
        }
      </nav>
    </div>

    <!-- Hero Content Grid: 8 cols for title, 4 cols for content -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 lg:gap-16">
      <!-- Left: Big Title (8 cols) -->
      <div class="lg:col-span-8">
        <h1
          class="font-display text-9xl sm:text-9xl lg:text-[11rem] xl:text-[13rem] font-normal mb-8 tracking-tight"
        >
          {currentService.title}
        </h1>
      </div>

      <!-- Right: Extended Description and Button (4 cols) -->
      <div
        class="lg:col-span-4 flex flex-col justify-between lg:pt-8 min-h-full"
      >
        <!-- Extended Description -->
        {
          currentService.extendedDescription && (
            <div
              class="text-2xl sm:text-end text-start leading-tight mb-8 lg:mb-0"
              set:html={currentService.extendedDescription}
            />
          )
        }

        <!-- Let's Talk Button (Bottom Right) -->
        <div class="flex justify-start sm:justify-end mt-auto">
          <button
            data-contact-modal="true"
            class="group inline-flex items-center gap-3 pl-8 pr-4 py-4 rounded-full text-base uppercase tracking-wider transition-all duration-300 hover:opacity-90 cursor-pointer bg-[var(--color-foreground)] text-[var(--color-background)]"
          >
            <span class="font-medium"
              >{letsTalk}</span
            >
            <span
              class="w-10 h-10 rounded-full flex items-center justify-center bg-[var(--hero-accent)] transition-transform duration-300 ease-in-out transform -rotate-45 group-hover:rotate-0"
              aria-hidden="true"
            >
              <svg
                class="w-6 h-6 text-[var(--color-background)]"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M5 12h14M12 5l7 7-7 7"></path>
              </svg>
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- Checklist Section (Within Hero) -->
    {
      (currentService.sectionHeading ||
        (currentService.checklistItems && currentService.checklistItems.length > 0)) && (
        <div class="mt-24 lg:mt-32 grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16">
          <!-- Left: Heading and Subheading -->
          <div>
            {currentService.sectionHeading && (
              <h2
                class="font-display text-4xl sm:text-5xl lg:text-6xl font-normal leading-tight"
              >
                {currentService.sectionHeading}
              </h2>
            )}
            {currentService.sectionSubheading && (
              <p class="mt-4 text-lg text-foreground/80">
                {currentService.sectionSubheading}
              </p>
            )}
          </div>

          <!-- Right: Checklist Items -->
          {currentService.checklistItems && currentService.checklistItems.length > 0 && (
            <ul class="space-y-0">
              {currentService.checklistItems.map((item, index) => (
                <li
                  class:list={[
                    "flex items-center gap-3 py-5 border-b border-foreground/10",
                    index === (currentService.checklistItems?.length || 0) - 1 && "border-b-0",
                  ]}
                >
                  <div
                    class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 bg-[var(--hero-accent)]"
                  >
                    <svg
                      class="w-4 h-4 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="3"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                  </div>
                  <span class="text-base sm:text-lg">{item.text}</span>
                </li>
              ))}
            </ul>
          )}
        </div>
      )
    }
  </div>
</section>

<style>
  .service-tab[data-active="true"] {
    pointer-events: none;
  }

  /* Theme-based background switching */
  .hero-bg-light {
    display: block;
  }

  .hero-bg-dark {
    display: none;
  }

  :global(.dark) .hero-bg-light {
    display: none;
  }

  :global(.dark) .hero-bg-dark {
    display: block !important;
  }

  /* Hide scrollbar for Chrome, Safari and Opera */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Hide scrollbar for IE, Edge and Firefox */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
</style>

<script>
  // Theme-based background switching is now handled by CSS only
</script>
