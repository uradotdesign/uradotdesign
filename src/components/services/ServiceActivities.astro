---
export interface Activity {
  title: string;
  description: string;
  isOpen?: boolean;
}

export interface Props {
  activities: Activity[];
  accentColor?: string;
  caseStudy?: {
    title: string;
    subtitle: string;
    description: string;
    image?: string | { light: string; dark: string } | null;
    link: string;
    linkText?: string;
    logo?: string | null;
  } | null;
}

const { activities, accentColor = "#10b981", caseStudy } = Astro.props;
const defaultLinkText = caseStudy?.linkText || "See how it worked";
---

<section class="relative py-20 lg:py-32" data-accent-color={accentColor}>
  <div class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-12 xl:px-16">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20">
      <!-- Left: Activities Section -->
      <div>
        <!-- Activities Heading -->
        <div class="mb-12 flex items-center gap-6" aria-hidden="true">
          <span
            class="text-[12px] sm:text-xs font-mono uppercase text-foreground/70 whitespace-nowrap"
          >
            ACTIVITIES
          </span>
          <div class="h-px flex-1 bg-[var(--color-border)]"></div>
        </div>

        <!-- Accordion -->
        <div class="space-y-0" data-spotlight-container role="list">
          {
            activities.map((activity, index) => (
              <details
                class:list={[
                  "group border-foreground/20",
                  index === 0 ? "border-t-0" : "border-t",
                ]}
                open={activity.isOpen}
                role="listitem"
              >
                <summary class="w-full py-8 flex items-center justify-between text-left relative cursor-pointer list-none marker:hidden focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--color-border)]">
                  <h3 class="spotlight-text text-2xl sm:text-3xl lg:text-4xl font-normal leading-tight pr-8 font-display">
                    {activity.title}
                  </h3>
                  <span
                    class="flex-shrink-0 w-6 h-6 flex items-center justify-center relative text-current"
                    aria-hidden="true"
                  >
                    <svg
                      class="w-6 h-6 absolute transition duration-200 ease-out group-open:opacity-0 group-open:scale-75 group-open:rotate-90"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 4.5v15m7.5-7.5h-15"
                      />
                    </svg>
                    <svg
                      class="w-6 h-6 absolute opacity-0 scale-75 rotate-90 transition duration-200 ease-out group-open:opacity-100 group-open:scale-100 group-open:rotate-0"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19.5 12h-15"
                      />
                    </svg>
                  </span>
                </summary>

                <div class="accordion-content animate-slide-down overflow-hidden">
                  <div class="pb-8 pr-14">
                    <p class="spotlight-text text-base sm:text-lg font-light leading-relaxed text-foreground/70">
                      {activity.description}
                    </p>
                  </div>
                </div>
              </details>
            ))
          }
        </div>
      </div>

      <!-- Right: Case Study Card -->
      <div>
        {caseStudy && (
          <>
        <div class="mb-12 flex items-center gap-6" aria-hidden="true">
          <span
            class="text-[12px] sm:text-xs font-mono uppercase text-foreground/70 whitespace-nowrap"
          >
            RELEVANT CASE STUDY
          </span>
          <div class="h-px flex-1 bg-[var(--color-border)]"></div>
        </div>
            
            <a
              href={caseStudy.link}
              class="group flex flex-col relative overflow-hidden rounded-2xl border border-foreground/10 hover:border-foreground/20 transition-all duration-300 hover:-translate-y-0.5 min-h-[400px] aspect-[4/5] md:aspect-[3/4] lg:aspect-auto"
            >
              <!-- Background Image (if provided) -->
              {
                caseStudy.image && (
                  <div class="absolute inset-0 z-0">
                    {typeof caseStudy.image === "string" ? (
                      <img
                        src={caseStudy.image}
                        alt={caseStudy.title}
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                      />
                    ) : (
                      <>
                        <img
                          src={caseStudy.image.light}
                          alt={caseStudy.title}
                          class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 dark:hidden"
                        />
                        <img
                          src={caseStudy.image.dark}
                          alt={caseStudy.title}
                          class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 hidden dark:block"
                        />
                      </>
                    )}
                  </div>
                )
              }

              <!-- Gradient Overlay -->
              <div class="absolute inset-0 pointer-events-none z-10 card-gradient-overlay"></div>

              <!-- Card Content -->
              <div class="relative z-20 flex-1 w-full flex flex-col justify-between p-8 sm:p-10">
                <!-- Top: Logo or Client Name -->
                <div class="flex justify-start">
                  {caseStudy.logo ? (
                    <div
                      class="w-auto h-8 bg-[var(--color-foreground)] transition-colors duration-300"
                      style={{
                        maskImage: `url(${caseStudy.logo})`,
                        maskSize: "contain",
                        maskRepeat: "no-repeat",
                        maskPosition: "left top",
                        WebkitMaskImage: `url(${caseStudy.logo})`,
                        WebkitMaskSize: "contain",
                        WebkitMaskRepeat: "no-repeat",
                        WebkitMaskPosition: "left top",
                        width: "120px", // Approximate width for mask
                      }}
                    />
                  ) : (
                    <p class="text-sm font-mono uppercase tracking-wider">
                      {caseStudy.subtitle}
                    </p>
                  )}
                </div>

                <!-- Bottom: Title and CTA -->
                <div>
                  <!-- Title (large serif heading) -->
                  <h3
                    class="font-display text-3xl sm:text-4xl lg:text-5xl font-normal leading-tight mb-4 text-[var(--color-foreground)]"
                  >
                    {caseStudy.title}
                  </h3>

                  <!-- Link with Arrow -->
                  <div
                    class="w-full flex items-center justify-between text-sm sm:text-base font-medium text-[var(--color-foreground)] border-b border-[var(--color-foreground)]/60 pb-3 transition-all duration-300 group-hover:border-[var(--color-foreground)]"
                  >
                    <span>{defaultLinkText}</span>
                    <svg
                      class="w-5 h-5 opacity-70 rotate-0 transition-all duration-300 ease-in-out group-hover:opacity-100 group-hover:rotate-45"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      aria-hidden="true"
                    >
                      <path
                        d="M7 17L17 7M17 7H7M17 7V17"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </div>
                </div>
              </div>
            </a>
          </>
        )}
      </div>
    </div>
  </div>
</section>

<script>
  // Spotlight effect for activity titles (copied from Certifications)
  function initSpotlight() {
    const container = document.querySelector("[data-spotlight-container]");
    if (!container) return;
    if (container.hasAttribute("data-spotlight-ready")) return;
    container.setAttribute("data-spotlight-ready", "true");

    const section = document.querySelector("[data-accent-color]");
    const spotlightColor = section
      ? section.getAttribute("data-accent-color")
      : "#10b981";
    const allTextElements = container.querySelectorAll(".spotlight-text");

    function updateSpotlight(clientX: number, clientY: number) {
      allTextElements.forEach((textEl) => {
        const htmlEl = textEl as HTMLElement;
        const textRect = htmlEl.getBoundingClientRect();

        // Calculate position relative to each text element
        const x = clientX - textRect.left;
        const y = clientY - textRect.top;

        htmlEl.style.setProperty("--mouse-x", `${x}px`);
        htmlEl.style.setProperty("--mouse-y", `${y}px`);
        htmlEl.style.setProperty("--spotlight-color", spotlightColor);
      });
    }

    // Mouse events
    container.addEventListener("mouseenter", () => {
      allTextElements.forEach((textEl) => {
        textEl.classList.add("spotlight-active");
      });
    });

    container.addEventListener("mouseleave", () => {
      allTextElements.forEach((textEl) => {
        textEl.classList.remove("spotlight-active");
      });
    });

    container.addEventListener("mousemove", (e) => {
      const mouseEvent = e as MouseEvent;
      requestAnimationFrame(() => {
      updateSpotlight(mouseEvent.clientX, mouseEvent.clientY);
    });
    }, { passive: true });
  }

  // Init Accordion Animation
  function initAccordion() {
    const details = document.querySelectorAll("details");

    details.forEach((detail) => {
      if ((detail as any).__accordionInit) return;
      (detail as any).__accordionInit = true;

      detail.addEventListener("toggle", () => {
        const d = detail as HTMLDetailsElement;
        if (d.open) {
          const content = d.querySelector(".accordion-content") as HTMLElement;
          if (content) {
            // Reset animation
            content.classList.remove("animate-slide-down");
            void content.offsetWidth; // Force reflow
            content.classList.add("animate-slide-down");
          }
        }
      });
    });
  }

  // Initialize on page load
  function init() {
    initSpotlight();
    initAccordion();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  // Re-initialize after custom page lifecycle events
  document.addEventListener("astro:page-load", init);
</script>

<style>
  /* Spotlight effect on activity titles (exact copy from Certifications) */
  .spotlight-text {
    position: relative;
    --mouse-x: 0px;
    --mouse-y: 0px;
    --spotlight-color: #10b981;
  }

  .spotlight-text.spotlight-active {
    background:
      radial-gradient(
        circle 150px at var(--mouse-x) var(--mouse-y),
        var(--spotlight-color) 0%,
        var(--spotlight-color) 20%,
        transparent 100%
      ),
      linear-gradient(currentColor, currentColor);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    transition: background 0.05s ease;
  }

  /* Card Gradient Overlay - Adjusted for light/dark theme */
  .card-gradient-overlay {
    background: linear-gradient(
      to top,
      var(--card-gradient-start) 0%,
      var(--card-gradient-mid) 40%,
      var(--card-gradient-end) 100%
    );
  }

  /* Default (Light) Theme Variables */
  :global(:root) {
    --card-gradient-start: rgba(255, 255, 255, 0.95);
    --card-gradient-mid: rgba(255, 255, 255, 0.6);
    --card-gradient-end: rgba(255, 255, 255, 0.1);
  }

  /* Dark Theme Variables */
  :global(.dark) {
    --card-gradient-start: rgba(3, 7, 18, 0.9);
    --card-gradient-mid: rgba(3, 7, 18, 0.6);
    --card-gradient-end: rgba(3, 7, 18, 0.1);
  }
</style>
